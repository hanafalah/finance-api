services:
  finance:
    container_name: finance-api
    image: finance-api
    build:
      context: .
      dockerfile: ./docker/common/Dockerfile
      target: development
    ports:
      - "${APP_PORT:-9100}:${APP_PORT:-9100}"
    volumes:
      - ./repositories:/app/repositories
      - ./app:/app/app
      - ./config:/app/config
      - ./public:/app/public
      - ./database:/app/database
      - ./projects/finance-gateway:/app/projects/finance-gateway
      - ./routes/api-gateway.php:/app/routes/api.php
      - ./composer_gateway.json:/app/composer.json
      - ./.env.gateway:/app/.env
      - finance_storage:/app/storage
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9100 || exit 1"]
    networks:
      - caddy-projects
    entrypoint: ["/usr/local/bin/entrypoint.gateway.sh"]
    env_file:
      - .env.gateway
    environment:
        PHP_INI_SCAN_DIR: /usr/local/etc/php/conf.d
        PHP_UPLOAD_MAX_FILESIZE: 10M
        PHP_POST_MAX_SIZE: 10M

  finance_listener:
    container_name: finance-listener
    image: finance-api
    volumes:
      - ./repositories:/app/repositories
      - ./app:/app/app
      - ./config:/app/config
      - ./public:/app/public
      - ./database:/app/database
      - ./projects/finance-gateway:/app/projects/finance-gateway
      - ./routes/api-gateway.php:/app/routes/api.php
      - ./composer_gateway.json:/app/composer.json
      - ./.env.gateway:/app/.env
      - finance_storage:/app/storage
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    ports:
      - "9108:9108"
    networks:
      - caddy-projects
    entrypoint: ["/usr/local/bin/entrypoint.worker.sh"]     # <â€” WORKER MODE
    depends_on:
      - finance
    env_file:
      - .env.gateway

  finance_hq:
    container_name: finance-hq
    image: finance-hq
    build:
      context: .
      dockerfile: ./docker/common/Dockerfile-hq
      target: development
    ports:
      - "9104:9104"
    volumes:
      - ./repositories:/app/repositories
      - ./app:/app/app
      - ./projects/finance-hq:/app/projects/finance-hq
      - ./config:/app/config
      - ./public:/app/public
      - ./routes:/app/routes
      - ./database:/app/database
      - ./routes/api-hq.php:/app/routes/api.php
      - ./.env.hq:/app/.env
      - ./composer_hq.json:/app/composer.json
      - finance_hq_storage:/app/storage
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9104 || exit 1"]
    networks:
      - caddy-projects
    entrypoint: ["/usr/local/bin/entrypoint.hq.sh"]
    env_file:
      - .env.hq
    environment:
        PHP_INI_SCAN_DIR: /usr/local/etc/php/conf.d
        PHP_UPLOAD_MAX_FILESIZE: 10M
        PHP_POST_MAX_SIZE: 10M

networks:
  caddy-projects:
    external: true

volumes:  
  finance_storage:
  finance_listener:
  finance_hq_storage:
  # finance_hq_storage: